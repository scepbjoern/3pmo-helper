<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3PMo Helper</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="vendor/xlsx.full.min.js"></script>
  <script src="grading.js"></script>
  <script src="persistence.js"></script>
  <script defer src="script.js"></script>
</head>
<body>
  <div class="container">
    <h1>3PMo Helper</h1>

    <div class="tabs">
      <button id="tabSQ" class="tab active" type="button">StudentQuiz-Bewertung</button>
      <button id="tabAssign" class="tab" type="button">Studierenden-Themenzuteilung</button>
    </div>

    <section id="page-sq" class="page active" aria-labelledby="tabSQ">
      
      <!-- Bereich 1: Übersicht & Test-Verwaltung -->
      <details class="wizard-section" open>
        <summary><h2>1. Übersicht & Test-Verwaltung</h2></summary>
        <div class="wizard-content">
          <p class="hint">Willkommen beim StudentQuiz-Bewertungs-Wizard. Folgen Sie diesen Schritten:</p>
          <ol>
            <li><strong>Test auswählen/anlegen:</strong> Wählen Sie einen bestehenden Test oder legen Sie einen neuen an.</li>
            <li><strong>StudentQuiz-Tabelle extrahieren:</strong> Kopieren Sie die HTML-Tabelle aus dem Reiter "StudentQuiz" der Moodle-Aktivität und extrahieren Sie die relevanten Fragendaten.</li>
            <li><strong>Rangliste-Tabelle extrahieren:</strong> Kopieren Sie die HTML-Tabelle aus dem Reiter "Rangliste" der Moodle-Aktivität und extrahieren Sie die Studierendenleistungen.</li>
            <li><strong>Bewertungen:</strong> Automatische Bewertung wird berechnet. Sie können manuelle Anpassungen und Begründungen direkt in der Tabelle eingeben (werden automatisch gespeichert).</li>
            <li><strong>Export:</strong> Laden Sie die finalen Bewertungen als Excel-Datei herunter.</li>
          </ol>

          <div class="test-management">
            <h3>Test-Verwaltung</h3>
            
            <label for="testNameInput" class="label">Testname</label>
            <input type="text" id="testNameInput" placeholder="z.B. Test 1, HS2024, etc." />
            
            <div class="buttons">
              <button id="btnNewTest" type="button" class="primary">Neuer Test</button>
              <button id="btnLoadTest" type="button">Test laden</button>
              <button id="btnSaveTest" type="button" class="success">Test exportieren (JSON)</button>
              <button id="btnImportTest" type="button">Test importieren (JSON)</button>
            </div>
            <input type="file" id="testFileInput" accept=".json" style="display: none;" />
            
            <div id="testStatus" class="status" role="status" aria-live="polite"></div>
            
            <details class="note">
              <summary>Hinweis zur Datenspeicherung</summary>
              <ul>
                <li><strong>Automatisches Speichern:</strong> Änderungen an manuellen Bewertungen werden automatisch im Browser (LocalStorage) gespeichert.</li>
                <li><strong>Test exportieren:</strong> Sichern Sie Ihre Daten als JSON-Datei auf Ihrer Festplatte.</li>
                <li><strong>Test importieren:</strong> Laden Sie eine zuvor exportierte JSON-Datei.</li>
                <li><strong>Mehrere Tests:</strong> Sie können verschiedene Tests parallel verwalten (z.B. "Test 1", "Test 2").</li>
              </ul>
            </details>
          </div>

          <div class="helper-tables" style="margin-top: 24px;">
            <h3>Hilfstabellen für Validierung</h3>
            
            <div class="upload-section">
              <label>
                <strong>Studierenden-Hilfstabelle</strong> (Kürzel → Vorname Nachname):
                <input type="file" id="studentHelperFile" accept=".xlsx,.xls" style="margin-left: 8px;">
              </label>
              <button id="btnUploadStudentHelper" type="button" class="primary">Hochladen</button>
              <button id="btnClearStudentHelper" type="button" class="secondary" style="display: none;">Daten löschen</button>
              <div id="statusStudentHelper" class="status" style="margin-top: 8px;"></div>
            </div>

            <div class="upload-section" style="margin-top: 16px;">
              <label>
                <strong>Zuteilungstabelle für aktuellen Test</strong> (aus Tab "Studierenden-Themenzuteilung"):
                <input type="file" id="assignmentFile" accept=".xlsx,.xls" style="margin-left: 8px;">
              </label>
              <button id="btnUploadAssignment" type="button" class="primary">Hochladen</button>
              <button id="btnClearAssignment" type="button" class="secondary" style="display: none;">Daten löschen</button>
              <div id="statusAssignment" class="status" style="margin-top: 8px;"></div>
            </div>
          </div>
        </div>
      </details>

      <!-- Bereich 2: StudentQuiz-Tabelle extrahieren -->
      <details class="wizard-section" open>
        <summary><h2>2. StudentQuiz-Tabelle extrahieren</h2></summary>
        <div class="wizard-content">
          <p class="hint">Fügen Sie unten HTML mit der Tabelle aus dem Reiter "StudentQuiz" einer Moodle-Aktivität "StudentQuiz" ein. Extrahiert werden: <strong>questionname</strong>, <strong>creatorname</strong>, <strong>difficultylevel</strong>, <strong>rate</strong>, <strong>comments</strong>. Danach können Sie die Daten als Excel herunterladen.</p>

          <label for="htmlInput" class="label">HTML-Eingabe</label>
          <textarea id="htmlInput" placeholder="Hier HTML-Code einfügen..."></textarea>

          <div class="buttons">
            <button id="btnParse" type="button" class="primary">Extrahieren & Vorschau</button>
            <button id="btnClear" type="button" class="secondary">Leeren</button>
            <button id="btnDownload" type="button" class="success">Als Excel herunterladen</button>
            <button id="btnClearSavedHtml" type="button" class="secondary" style="display: none;">Gespeicherte Daten löschen</button>
          </div>

          <div id="status" class="status" role="status" aria-live="polite"></div>

          <div class="table-wrapper">
            <table id="previewTable">
              <thead>
                <tr>
                  <th>questionname</th>
                  <th>creatorname</th>
                  <th>difficultylevel</th>
                  <th>rate</th>
                  <th>comments</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <details class="note">
            <summary>Hinweis zur Extraktion</summary>
            <ul>
              <li><strong>difficultylevel</strong> wird nur aus <code>data-difficultylevel</code> gelesen. Falls nicht vorhanden, bleibt das Feld leer.</li>
              <li><strong>rate</strong> wird nur aus <code>data-rate</code> gelesen. Falls nicht vorhanden, bleibt das Feld leer.</li>
              <li><strong>comments</strong>: "n.a." wird als 0 gezählt.</li>
            </ul>
          </details>
        </div>
      </details>

      <!-- Bereich 3: Rangliste-Tabelle extrahieren -->
      <details class="wizard-section" open>
        <summary><h2>3. Rangliste-Tabelle extrahieren</h2></summary>
        <div class="wizard-content">
          <p class="hint">Fügen Sie unten HTML mit der Tabelle aus dem Reiter "Rangliste" einer Moodle-Aktivität "StudentQuiz" ein. Extrahiert werden: <strong>student_name</strong>, <strong>published_question_points</strong>, <strong>rating_points</strong>, <strong>correct_answers_points</strong>, <strong>false_answers_points</strong>. Danach können Sie die Daten als Excel herunterladen.</p>

          <label for="htmlInputRanking" class="label">HTML-Eingabe</label>
          <textarea id="htmlInputRanking" placeholder="Hier HTML-Code einfügen..."></textarea>

          <div class="buttons">
            <button id="btnParseRanking" type="button" class="primary">Extrahieren & Vorschau</button>
            <button id="btnClearRanking" type="button" class="secondary">Leeren</button>
            <button id="btnDownloadRanking" type="button" class="success">Als Excel herunterladen</button>
            <button id="btnClearSavedRankingHtml" type="button" class="secondary" style="display: none;">Gespeicherte Daten löschen</button>
          </div>

          <div id="statusRanking" class="status" role="status" aria-live="polite"></div>

          <div class="table-wrapper">
            <table id="previewTableRanking">
              <thead>
                <tr>
                  <th>student_name</th>
                  <th>published_question_points</th>
                  <th>rating_points</th>
                  <th>correct_answers_points</th>
                  <th>false_answers_points</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <details class="note">
            <summary>Hinweis zur Extraktion</summary>
            <ul>
              <li>Die Extraktion erfolgt analog zur StudentQuiz-Tabelle.</li>
              <li>Punktwerte werden als numerische Werte extrahiert.</li>
            </ul>
          </details>
        </div>
      </details>

      <!-- Bereich 4: Bewertungen -->
      <details class="wizard-section" open>
        <summary><h2>4. Bewertungen</h2></summary>
        <div class="wizard-content">
          <p class="hint">In diesem Bereich werden basierend auf den extrahierten Daten aus den Bereichen 2 und 3 automatisch Bewertungen für die Studierenden berechnet. Sie können die automatisch generierten Bewertungen manuell überschreiben und Begründungen hinzufügen. Am Ende können Sie die finalen Bewertungen als Excel-Datei exportieren.</p>
          
          <div class="buttons">
            <button id="btnGenerateGrades" type="button" class="primary" disabled>Bewertungen generieren</button>
            <button id="btnDownloadGrades" type="button" class="success" disabled>Bewertungen als Excel herunterladen</button>
          </div>

          <div id="statusGrades" class="status" role="status" aria-live="polite"></div>

          <div class="buttons" id="gradeFilterButtons" style="display: none;">
            <button id="btnFilterManual" type="button">Nur manuell zu Bewertende anzeigen</button>
            <button id="btnShowAll" type="button">Alle anzeigen</button>
          </div>

          <div class="table-height-control" id="tableHeightControl" style="display: none;">
            <label for="tableHeightSlider">Tabellenhöhe: <span id="tableHeightValue">600</span>px</label>
            <input type="range" id="tableHeightSlider" min="300" max="1200" value="600" step="50">
          </div>

          <div class="table-wrapper" id="gradesTableWrapper">
            <table id="gradesTable">
              <thead>
                <tr>
                  <th>Manuell</th>
                  <th class="sortable" data-sort="student_name" data-order="asc">Student ▲</th>
                  <th class="sortable" data-sort="total_grade">Bew. tot.</th>
                  <th class="sortable" data-sort="automatic_grade">Bew. aut.</th>
                  <th class="sortable" data-sort="manual_grade">Bew. man.</th>
                  <th>Begründung</th>
                  <th class="sortable" data-sort="published_question_points">Punkte veröffentlichte Fragen¹</th>
                  <th class="sortable" data-sort="rating_points">Punkte Sterne²</th>
                  <th class="sortable" data-sort="total_comments">Σ Kommentare</th>
                  <th class="sortable" data-sort="avg_difficultylevel">Ø Schwierigkeit</th>
                  <th class="sortable" data-sort="wrong_block">Falscher Frageblock</th>
                  <th class="sortable" data-sort="total_answers_points">Punkte Antworten³</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <details class="note">
            <summary>Hinweise zu den Spalten</summary>
            <ul>
              <li><strong>¹ Punkte veröffentlichte Fragen:</strong> Zeigt die Punkte für veröffentlichte Fragen an. In Klammern: Anzahl der erstellten Fragen.</li>
              <li><strong>² Punkte Sterne:</strong> Zeigt die Punkte für Sterne (Bewertungen) an. Wenn die durchschnittliche Bewertung abweicht, wird sie in Klammern angezeigt.</li>
              <li><strong>³ Punkte Antworten:</strong> Format: Gesamt (R: Richtig / F: Falsch). Zeigt die Gesamtpunkte für Antworten sowie die Aufteilung in richtige und falsche Antworten.</li>
            </ul>
          </details>

          <details class="note">
            <summary>Hinweise zur Bewertung</summary>
            
            <h4>Automatische Bewertung (0-100%)</h4>
            <p>Gewichtete Gesamtbewertung aus drei Aspekten:</p>
            <ul>
              <li><strong>Frage erstellt (50%):</strong> 0 Fragen = 0%, 1 Frage = 100%, mehr als 1 Frage = 70%</li>
              <li><strong>Fragebewertung (25%):</strong> Basierend auf erhaltenen Sternen pro veröffentlichter Frage, normalisiert auf Skala 2-5 (≤2 Sterne = 0%, 5 Sterne = 100%, linear dazwischen)</li>
              <li><strong>Fragen beantwortet (25%):</strong> Basierend auf Summe der Antwortpunkte, normalisiert auf max. 5 Punkte (≥5 Punkte = 100%)</li>
            </ul>
            <p><strong>Formel:</strong> 50% × Bewertung_FrageErstellt + 25% × Bewertung_FrageBewertung + 25% × Bewertung_FragenBeantwortung</p>
            
            <h4>Automatische Markierung für manuelle Bewertung</h4>
            <p>Ein Eintrag wird automatisch als "Manuell zu bewerten" markiert (rot hervorgehoben), wenn eines der folgenden Kriterien zutrifft:</p>
            <ul>
              <li><strong>Mehr als eine Frage erstellt:</strong> Anzahl Fragen > 1 (ungewöhnlich, könnte auf Fehler hindeuten)</li>
              <li><strong>Punkte Sterne < 4:</strong> Niedrige Bewertung der erstellten Frage(n), deutet auf Qualitätsprobleme hin</li>
              <li><strong>Σ Kommentare < 3:</strong> Zu wenige Bewertungen der Frage (< 3 Studierende), daher ist die Aussagekraft der Punkte Sterne nicht ausreichend. Die Qualität der Frage muss manuell geprüft werden</li>
              <li><strong>Punkte Antworten < 5:</strong> Zu wenig Engagement beim Beantworten von Fragen (25% der Bewertung)</li>
              <li><strong>Mehr falsche als richtige Antworten:</strong> Deutet darauf hin, dass der Studierende möglicherweise geraten hat statt die Fragen ernsthaft zu beantworten (erkennbar an geringer investierter Zeit)</li>
              <li><strong>Falscher Frageblock:</strong> Frage wurde im falschen thematischen Block erstellt (Zuteilungsfehler)</li>
            </ul>
            <p><strong>Zweck:</strong> Diese Kriterien helfen dabei, Studierende zu identifizieren, die besondere Aufmerksamkeit benötigen oder bei denen die automatische Bewertung möglicherweise nicht angemessen ist.</p>
            
            <h4>Manuelle Bewertung</h4>
            <p>Kann verwendet werden, um die automatische Bewertung zu überschreiben. Begründungen helfen bei der Nachvollziehbarkeit und Transparenz gegenüber den Studierenden.</p>
          </details>
        </div>
      </details>

    </section>

    <section id="page-assign" class="page" aria-labelledby="tabAssign">
      <p class="hint">Studierenden-Themenzuteilung: Laden Sie eine Excel-Datei mit den Spalten <strong>Kuerzel</strong> und <strong>Klasse</strong> hoch, geben Sie die Testnummer und die Blöcke an und erzeugen Sie die Zuteilung.</p>

      <label for="studentsFile" class="label">Excel mit Studierenden (Kuerzel, Klasse)</label>
      <input id="studentsFile" type="file" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" />

      <label for="testNumber" class="label">Testnummer (1–12)</label>
      <input id="testNumber" type="number" min="1" max="12" placeholder="z. B. 3" />

      <label for="blocksInput" class="label">Blöcke (Semikolon-getrennt, Format: Semesterwoche_Folienbereich)</label>
      <input id="blocksInput" type="text" placeholder="z. B. 1_8-12; 1_13-17; 2_2-6" />

      <div class="buttons">
        <button id="btnTemplate" type="button" class="secondary">Template herunterladen</button>
        <button id="btnAssign" type="button" class="primary">Zuteilen & Vorschau</button>
        <button id="btnDownloadAssign" type="button" class="success">Als Excel herunterladen</button>
      </div>

      <div id="assignStatus" class="status" role="status" aria-live="polite"></div>

      <div id="assignSummary"></div>

      <div class="table-wrapper">
        <table id="assignPreviewTable">
          <thead>
            <tr>
              <th>Kürzel</th>
              <th>Klasse</th>
              <th>Frage erstellen in Block</th>
              <th>Fragen beantworten in Blöcken</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <details class="note">
        <summary>Hinweis zum Blöcke-Format</summary>
        <ul>
          <li>Format pro Block: <code>Semesterwoche_Folienbereich</code> (z. B. <code>1_8-12</code>).</li>
          <li>Mehrere Blöcke semikolongetrennt (z. B. <code>1_8-12; 1_13-17; 2_2-6</code>).</li>
          <li>Im Output werden Wochen zweistellig formatiert (z. B. <code>SW01F8-12</code>).</li>
        </ul>
      </details>
    </section>
  </div>
</body>
</html>
